name: Build native openconnect-wrapper and upload release asset

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-native-wrapper-linux:
    name: Build native openconnect-wrapper (.so) on Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool pkg-config libssl-dev libxml2-dev liblz4-dev libproxy-dev gettext openjdk-17-jdk ant

      - name: Configure and build with Java support
        run: |
          if [ -x ./autogen.sh ]; then
            ./autogen.sh
          fi
          ./configure --with-java --with-vpnc-script=/etc/vpnc/vpnc-script
          make

      - name: Build Java JNI wrapper
        run: |
          cd java
          ant

      - name: Locate native wrapper library (.so)
        id: findlib_so
        run: |
          echo 'Searching for *openconnect* libraries in workspace (Linux)...'
          find . -maxdepth 8 -type f -name '*openconnect*' -print || true

          LIB_PATH=$(find . -maxdepth 8 -type f -name 'libopenconnect-wrapper.so*' | head -n 1)

          if [ -z "$LIB_PATH" ]; then
            echo 'libopenconnect-wrapper.so* not found'
            exit 1
          fi

          echo "Found lib at $LIB_PATH"
          echo "lib_path=$LIB_PATH" >> "$GITHUB_OUTPUT"

      - name: Upload native library (.so) as release asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.findlib_so.outputs.lib_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-native-wrapper-windows:
    name: Build native openconnect-wrapper (DLL) on Windows
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-pkg-config
            autoconf
            automake
            libtool
            gettext
            mingw-w64-x86_64-libxml2
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-zlib
          msystem: MINGW64

      - name: Configure and build with Java support (MSYS2)
        shell: msys2 {0}
        run: |
          # Determine MSYS2-style JAVA_HOME and configure JNI includes
          JAVA_HOME_MSYS=$(cygpath -u "$JAVA_HOME")
          echo "JAVA_HOME_MSYS = $JAVA_HOME_MSYS"
          export JAVA_HOME="$JAVA_HOME_MSYS"
          export CPPFLAGS="-I$JAVA_HOME_MSYS/include -I$JAVA_HOME_MSYS/include/win32 -include winsock2.h"
          # Map getuid() to 0 on Windows to avoid implicit declaration error in JNI
          export CPPFLAGS="$CPPFLAGS -Dgetuid()=0"

          # Ensure vpnc-script is available inside MSYS2
          mkdir -p /etc/vpnc
          cp ./ci/vpnc-script /etc/vpnc/vpnc-script
          sed -i 's/\r$//' /etc/vpnc/vpnc-script
          chmod +x /etc/vpnc/vpnc-script

          # Fix potential CRLF issues introduced by Windows checkout before running autogen.sh
          if [ -f configure.ac ]; then
            sed -i 's/\r$//' configure.ac
          fi

          if [ -x ./autogen.sh ]; then
            ./autogen.sh
          fi

          # Work around Autoconf 2.72 undeclared builtins check on MinGW and use vpnc-script
          ac_cv_c_undeclared_builtin_options=none ./configure --with-java --with-vpnc-script=/etc/vpnc/vpnc-script || (test -f config.log && cat config.log; exit 1)

          # Build without treating warnings as errors on Windows
          make AM_CFLAGS='-Wall -Wextra -Wno-missing-field-initializers -Wno-sign-compare -Wno-unused-parameter -Wformat-nonliteral -Wformat-security -Winit-self -Wmissing-declarations -Wmissing-include-dirs -Wnested-externs -Wparentheses -Wpointer-arith -Wunused-function -Wwrite-strings'

      - name: Locate native wrapper library (DLL)
        id: findlib_dll
        shell: msys2 {0}
        run: |
          echo 'Searching for *openconnect* DLLs in workspace (Windows/MSYS2)...'
          find . -maxdepth 8 -type f -name '*openconnect*' -print || true

          DLL_PATH=$(find . -maxdepth 8 -type f -name '*openconnect-wrapper*.dll' | head -n 1)

          if [ -z "$DLL_PATH" ]; then
            echo '*openconnect-wrapper*.dll not found'
            exit 1
          fi

          echo "Found DLL at $DLL_PATH"
          echo "dll_path=$DLL_PATH" >> "$GITHUB_OUTPUT"

      - name: Upload native library (DLL) as release asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.findlib_dll.outputs.dll_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
